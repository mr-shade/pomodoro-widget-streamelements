<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Test</title>
    <link rel="stylesheet" href="./widget.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
        }
        
        .test-controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-controls h3 {
            color: white;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .test-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .test-btn:hover {
            background: #5b5bd6;
        }
        
        .test-btn.broadcaster { background: #f59e0b; }
        .test-btn.moderator { background: #10b981; }
        .test-btn.vip { background: #8b5cf6; }
        .test-btn.subscriber { background: #ec4899; }
    </style>
</head>
<body>
    <div class="test-controls">
        <h3>Test Chat Messages</h3>
        <div class="test-buttons">
            <button class="test-btn" onclick="testMessage('Viewer', 'Hello everyone!', 'viewer')">Viewer Message</button>
            <button class="test-btn broadcaster" onclick="testMessage('Streamer', 'Welcome to the stream!', 'broadcaster')">Broadcaster</button>
            <button class="test-btn moderator" onclick="testMessage('ModeratorBot', 'Please follow the rules!', 'moderator')">Moderator</button>
            <button class="test-btn vip" onclick="testMessage('VIPUser', 'Great stream today!', 'vip')">VIP</button>
            <button class="test-btn subscriber" onclick="testMessage('SubUser', 'Thanks for the content!', 'subscriber')">Subscriber</button>
            <button class="test-btn" onclick="spamMessages()">Spam Test</button>
            <button class="test-btn" onclick="clearChat()">Clear Chat</button>
        </div>
    </div>
    
    <div class="chat-widget">
        <div class="chat-header">
            <h3>Live Chat</h3>
        </div>
        <div class="chat-container" id="chat-container">
            <div class="chat-message welcome">
                <span class="username">System</span>
                <span class="message">Chat widget ready! Use the buttons above to test.</span>
            </div>
        </div>
    </div>

    <script>
        // Mock StreamElements environment for testing
        window.addEventListener('DOMContentLoaded', function() {
            // Simulate widget load event
            const mockFieldData = {
                maxMessages: 10,
                showTimestamps: 'no',
                fadeOldMessages: 'yes'
            };
            
            const mockEvent = {
                detail: {
                    fieldData: mockFieldData
                }
            };
            
            // Trigger the widget load event
            const event = new CustomEvent('onWidgetLoad', mockEvent);
            window.dispatchEvent(event);
        });
        
        function testMessage(username, message, role) {
            // Simulate the correct StreamElements event structure
            const mockEvent = {
                detail: {
                    listener: 'message',
                    event: {
                        nick: username,
                        displayName: username,
                        text: message,
                        tags: {
                            badges: role === 'viewer' ? '' : `${role}/1`,
                            'display-name': username,
                            color: '#641FEF'
                        },
                        time: Date.now(),
                        userId: Math.random().toString(36).substr(2, 9),
                        channel: 'testchannel',
                        isAction: false
                    }
                }
            };
            
            console.log('Dispatching mock event:', mockEvent);
            const event = new CustomEvent('onEventReceived', mockEvent);
            window.dispatchEvent(event);
        }
        
        function spamMessages() {
            const messages = [
                'This is message 1',
                'Another test message!',
                'Chat is working great!',
                'Testing the scroll feature',
                'More messages incoming...',
                'This should trigger cleanup',
                'Old messages should fade out',
                'New messages appear here'
            ];
            
            messages.forEach((msg, index) => {
                setTimeout(() => {
                    testMessage(`User${index + 1}`, msg, 'viewer');
                }, index * 500);
            });
        }
        
        function clearChat() {
            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div class="chat-message welcome">
                    <span class="username">System</span>
                    <span class="message">Chat cleared!</span>
                </div>
            `;
            if (window.chatWidget) {
                window.chatWidget.messageCount = 1;
            }
        }
    </script>
    <script src="./widget.js"></script>
</body>
</html>