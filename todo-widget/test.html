<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TODO Widget Test</title>
    <link rel="stylesheet" href="widget.css">
</head>

<body>
    <div class="tasklist-container">
        <h1 class="page-title">Tasklist</h1>
        
        <!-- Confetti canvas for celebration -->
        <canvas id="confetti-canvas"></canvas>

        <div class="task-card">
            <!-- <h2 class="card-title">MY TASKS</h2> -->

            <div class="task-list">
                <!-- Start with empty todo list - minimal height -->
            </div>
             <!-- Dynamic More Tasks Button (will be updated by JS) -->
            <div class="more-tasks-btn" style="display: none;">
                <span class="more-tasks-text">0+</span>
            </div>
        </div>

        <div class="progress-section">
            <div class="progress-bar-container">
                <div class="progress-info">
                    <span class="progress-count">0/0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="progress-info">
                    <span class="progress-percentage">0%</span>
                </div>
            </div>
            <!-- <p class="progress-label">Progress Bar</p> -->
        </div>
    </div>
    
    <!-- Test buttons for development -->
    <div class="dev-commands">
        <h4>Development Commands</h4>
        <div>
            <button onclick="testAddTask()">Add Test Task</button>
            <button onclick="testAddMultipleTasks()">Add Multiple Tasks</button>
            <button onclick="testCompleteTask()">Complete Task 1</button>
            <button onclick="testCompleteAll()">Complete All Tasks</button>
            <button onclick="testHighlight()">Highlight Random Task</button>
            <button onclick="testConfetti()">Test Confetti</button>
            <button onclick="testLockToggle()">Toggle Lock</button>
            <button onclick="testClearAll()">Clear All Tasks</button>
            <button onclick="testAutoScroll()">Test Auto-scroll</button>
        </div>
    </div>
    
    <script>
        // Mock StreamElements API for testing
        window.SE_API = {
            onMessage: function(callback) {
                console.log("Mock SE_API.onMessage called");
            }
        };

        let todoWidget;

        // Mock widget load event for testing
        setTimeout(() => {
            const event = new CustomEvent('onWidgetLoad', {
                detail: {
                    fieldData: {
                        cardTitle: "MY TASKS",
                        tasklistTitle: "Tasklist",
                        progressLabel: "Progress Bar",
                        cardTitleColor: "#feb6de",
                        taskTextColor: "#ffffff",
                        cardBackgroundColor: "#010161",
                        cardBorderColor: "#bee5fc",
                        cardBorderWidth: 6,
                        progressLabelColor: "#2c2c2c",
                        progressBarBorderColor: "#bee5fc",
                        progressBarBorderWidth: 5,
                        checkboxBorderColor: "#ffffff",
                        tickColor: "#6aacfd",
                        scrollbarColor: "#6aaafe",
                        commandsEnabled: true,
                        enableConfetti: true,
                        confettiColor1: "#ff6b6b",
                        confettiColor2: "#4ecdc4",
                        confettiColor3: "#45b7d1",
                        confettiColor4: "#96ceb4",
                        confettiColor5: "#ffeaa7",
                        confettiColor6: "#dda0dd",
                        confettiColor7: "#98d8c8",
                        confettiColor8: "#f7dc6f",
                        confettiParticleCount: 150,
                        confettiDuration: 4,
                        enableLockUnlock: true,
                        enableHighlight: true,
                        enableAddTask: true,
                        enableCompleteTask: true,
                        enableRemoveTask: true,
                        enableClearTasks: true,
                        lockCommand: "!lock",
                        unlockCommand: "!unlock",
                        highlightCommand: "!highlight",
                        addTaskPermission: "everyone",
                        completeTaskPermission: "everyone",
                        removeTaskPermission: "moderator",
                        clearTasksPermission: "moderator",
                        autoScrollTasksCompleted: 5,
                        scrollAmount: 3
                    }
                }
            });
            window.dispatchEvent(event);
        }, 100);

        // Test functions for development
        function testAddTask() {
            if (window._todoWidget) {
                const randomTasks = [
                    'Complete project documentation',
                    'Review code changes',
                    'Update dependencies',
                    'Fix bug in payment system',
                    'Write unit tests',
                    'Deploy to staging',
                    'Create user guides',
                    'Schedule team meeting'
                ];
                const randomTask = randomTasks[Math.floor(Math.random() * randomTasks.length)];
                window._todoWidget.addTask(randomTask, 'TestUser');
            }
        }

        function testAddMultipleTasks() {
            const tasks = [
                'Task 1: Review pull request',
                'Task 2: Write documentation',
                'Task 3: Fix styling issues',
                'Task 4: Update API endpoints',
                'Task 5: Test new features',
                'Task 6: Deploy changes'
            ];
            
            tasks.forEach((task, index) => {
                setTimeout(() => {
                    if (window._todoWidget) {
                        window._todoWidget.addTask(task, 'TestUser');
                    }
                }, index * 300); // Stagger the additions to see animation
            });
        }

        function testCompleteTask() {
            if (window._todoWidget) {
                const firstTask = document.querySelector('.task-item:not(.completed)');
                if (firstTask) {
                    const checkbox = firstTask.querySelector('.checkbox');
                    if (checkbox) checkbox.click();
                }
            }
        }

        function testCompleteAll() {
            if (window._todoWidget) {
                const checkboxes = document.querySelectorAll('.task-item:not(.completed) .checkbox');
                checkboxes.forEach((checkbox, index) => {
                    setTimeout(() => {
                        checkbox.click();
                    }, index * 200);
                });
            }
        }

        function testHighlight() {
            if (window._todoWidget) {
                window._todoWidget.highlightRandomTask('TestUser');
            }
        }

        function testConfetti() {
            if (window._todoWidget) {
                window._todoWidget.startConfetti();
            }
        }

        function testLockToggle() {
            if (window._todoWidget) {
                if (window._todoWidget.isLocked) {
                    window._todoWidget.isLocked = false;
                    console.log('Widget unlocked');
                } else {
                    window._todoWidget.isLocked = true;
                    console.log('Widget locked');
                }
            }
        }

        function testAutoScroll() {
            if (window._todoWidget) {
                // Add several tasks and complete them to test auto-scroll
                const tasks = ['Task A', 'Task B', 'Task C', 'Task D', 'Task E', 'Task F', 'Task G'];
                
                // Add tasks first
                tasks.forEach((task, index) => {
                    setTimeout(() => {
                        window._todoWidget.addTask(task, 'TestUser');
                    }, index * 100);
                });
                
                // Then complete them to trigger auto-scroll
                setTimeout(() => {
                    const checkboxes = document.querySelectorAll('.task-item:not(.completed) .checkbox');
                    checkboxes.forEach((checkbox, index) => {
                        if (index < 6) { // Complete first 6 tasks
                            setTimeout(() => {
                                checkbox.click();
                            }, index * 300);
                        }
                    });
                }, tasks.length * 100 + 1000);
            }
        }

        function testClearAll() {
            if (window._todoWidget) {
                window._todoWidget.clearTasks('TestUser');
            }
        }

        // Test chat command functionality
        function testChatCommand(command) {
            console.log(`Testing chat command: ${command}`);
            
            // Create mock chat message data in StreamElements format
            const mockChatData = {
                text: command,
                displayName: 'TestUser',
                nick: 'testuser',
                userId: '12345',
                tags: {
                    badges: 'broadcaster/1',
                    'display-name': 'TestUser',
                    mod: '0',
                    subscriber: '0',
                    vip: '0'
                },
                badges: [
                    {
                        type: 'broadcaster',
                        version: '1',
                        url: 'https://example.com/badge.png',
                        description: 'Broadcaster'
                    }
                ]
            };

            // Simulate StreamElements onEventReceived
            const event = new CustomEvent('onEventReceived', {
                detail: {
                    listener: 'message',
                    event: {
                        data: mockChatData
                    }
                }
            });
            
            window.dispatchEvent(event);
        }

        // Add buttons for testing chat commands
        function addChatTestButtons() {
            const testControls = document.querySelector('.test-controls');
            if (testControls) {
                const chatTestsDiv = document.createElement('div');
                chatTestsDiv.innerHTML = `
                    <h3>Chat Command Tests</h3>
                    <button onclick="testChatCommand('!addtask Test task from chat')">Test !addtask</button>
                    <button onclick="testChatCommand('!complete 1')">Test !complete</button>
                    <button onclick="testChatCommand('!remove 1')">Test !remove</button>
                    <button onclick="testChatCommand('!clear')">Test !clear</button>
                    <button onclick="testChatCommand('!highlight')">Test !highlight</button>
                    <button onclick="testChatCommand('!lock')">Test !lock</button>
                    <button onclick="testChatCommand('!unlock')">Test !unlock</button>
                `;
                testControls.appendChild(chatTestsDiv);
            }
        }

        // Add chat test buttons after widget loads
        setTimeout(addChatTestButtons, 500);
    </script>
    <script src="widget.js"></script>
</body>

</html>
