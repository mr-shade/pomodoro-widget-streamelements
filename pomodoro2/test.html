<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer Test</title>
    <link rel="stylesheet" href="./widget.css">
</head>
<body>
    <div class="timer-widget">
        <div class="timer-display">
            <div class="time-section">
                <div class="time-card">
                    <span class="time-number">2</span>
                    <span class="time-number">5</span>
                </div>
            </div>
            <div class="time-section">
                <div class="time-card">
                    <span class="time-number">0</span>
                    <span class="time-number">0</span>
                </div>
            </div>
            <div class="play-button">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
                    <path d="M8 5V19L19 12L8 5Z" fill="white" />
                </svg>
            </div>
        </div>
    </div>

    <!-- Test Controls -->
    <div style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 8px; font-family: Arial, sans-serif; font-size: 12px; z-index: 1000;">
        <h4 style="margin: 0 0 10px 0; color: #4299E1;">Pomodoro Test Controls</h4>
        <div style="margin-bottom: 10px;">
            <label>
                <input type="checkbox" id="enableTick" checked> Enable Tick Sound
            </label>
        </div>
        <div style="margin-bottom: 10px;">
            <label>
                Volume: <input type="range" id="volumeSlider" min="0" max="100" value="50" style="width: 80px;">
                <span id="volumeDisplay">50%</span>
            </label>
        </div>
        <div style="margin-bottom: 10px;">
            <label>
                Sound File: <input type="file" id="soundFile" accept=".mp3,.wav,.ogg" style="font-size: 10px;">
            </label>
        </div>
        <div style="margin-bottom: 10px;">
            <button id="testSound" style="padding: 5px 10px; font-size: 10px;">Test Tick Sound</button>
        </div>
        <div style="margin-bottom: 10px;">
            <button id="setShortTimer" style="padding: 5px 10px; font-size: 10px;">Set 10s Timer</button>
        </div>
        <div>
            <strong>Commands:</strong><br>
            !start - Start timer<br>
            !pause - Pause timer<br>
            !reset - Reset timer
        </div>
    </div>

    <script>
        // Mock StreamElements API for testing
        window.SE_API = {
            onMessage: function(callback) {
                window.mockMessageCallback = callback;
                console.log("Mock SE_API.onMessage registered");
            },
            sendMessage: function(message) {
                console.log("SE_API.sendMessage:", message);
            }
        };

        // Mock widget load event for testing
        let currentFieldData = {
            pomodoroMinutes: 25,
            cardColor: "#010161",
            cardBorderColor: "#fcfabc",
            timerCardStart: "#6caaff",
            timerCardEnd: "#4299E1",
            playBtnColor: "#63B3ED",
            playBtnIconColor: "#FFFFFF",
            timerTextColor: "#FFFFFF",
            enableTickSound: "true",
            tickSoundFile: "",
            tickSoundVolume: 50,
            // Role permission features
            commandsEnabled: true,
            startCommandPermission: "everyone",
            pauseCommandPermission: "moderator",
            resetCommandPermission: "moderator",
            blacklistedUsers: "",
            // Custom commands
            startCommand: "!start",
            pauseCommand: "!pause",
            resetCommand: "!reset"
        };

        setTimeout(() => {
            const event = new CustomEvent('onWidgetLoad', {
                detail: {
                    fieldData: currentFieldData
                }
            });
            window.dispatchEvent(event);
        }, 100);

        // Test controls functionality
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const enableTick = document.getElementById('enableTick');
                const volumeSlider = document.getElementById('volumeSlider');
                const volumeDisplay = document.getElementById('volumeDisplay');
                const soundFile = document.getElementById('soundFile');
                const testSound = document.getElementById('testSound');
                const setShortTimer = document.getElementById('setShortTimer');

                // Volume slider
                volumeSlider.addEventListener('input', function() {
                    const value = this.value;
                    volumeDisplay.textContent = value + '%';
                    currentFieldData.tickSoundVolume = parseInt(value);
                    if (window.pomodoroTimer) {
                        window.pomodoroTimer.updateTickSoundSettings(currentFieldData);
                    }
                });

                // Enable/disable tick sound
                enableTick.addEventListener('change', function() {
                    currentFieldData.enableTickSound = this.checked ? "true" : "false";
                    if (window.pomodoroTimer) {
                        window.pomodoroTimer.updateTickSoundSettings(currentFieldData);
                    }
                });

                // Sound file upload
                soundFile.addEventListener('change', function() {
                    const file = this.files[0];
                    if (file) {
                        const url = URL.createObjectURL(file);
                        currentFieldData.tickSoundFile = url;
                        if (window.pomodoroTimer) {
                            window.pomodoroTimer.updateTickSoundSettings(currentFieldData);
                        }
                        console.log('Sound file loaded:', file.name);
                    }
                });

                // Test sound button
                testSound.addEventListener('click', function() {
                    if (window.pomodoroTimer) {
                        window.pomodoroTimer.playTickSound();
                    }
                });

                // Set short timer for testing
                setShortTimer.addEventListener('click', function() {
                    if (window.pomodoroTimer) {
                        window.pomodoroTimer.minutes = 0;
                        window.pomodoroTimer.seconds = 10;
                        window.pomodoroTimer.updateDisplay();
                        console.log('Timer set to 10 seconds for testing');
                    }
                });

                // Add keyboard shortcuts for testing commands
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case '1':
                                e.preventDefault();
                                simulateCommand('!start');
                                break;
                            case '2':
                                e.preventDefault();
                                simulateCommand('!pause');
                                break;
                            case '3':
                                e.preventDefault();
                                simulateCommand('!reset');
                                break;
                        }
                    }
                });

                function simulateCommand(command) {
                    if (window.mockMessageCallback) {
                        window.mockMessageCallback({
                            message: command,
                            text: command
                        });
                        console.log('Simulated command:', command);
                    }
                }

                // Test role permissions with different user types
                function testRolePermissions() {
                    console.log('Testing role permissions...');
                    
                    // Test as viewer (should be able to start only)
                    setTimeout(() => testChatCommand('!start', 'viewer', 'testviewer'), 500);
                    
                    // Test as subscriber
                    setTimeout(() => testChatCommand('!pause', 'subscriber', 'testsubscriber'), 1000);
                    
                    // Test as moderator (should be able to do everything)
                    setTimeout(() => testChatCommand('!reset', 'moderator', 'testmod'), 1500);
                }

                function testChatCommand(command, role = 'viewer', username = 'testuser') {
                    console.log(`Testing ${command} as ${role}`);
                    
                    // Create mock StreamElements event data
                    const mockData = {
                        detail: {
                            event: {
                                data: {
                                    nick: username,
                                    user_name: username,
                                    tags: {
                                        badges: role === 'broadcaster' ? 'broadcaster/1' :
                                               role === 'moderator' ? 'moderator/1' :
                                               role === 'vip' ? 'vip/1' :
                                               role === 'subscriber' ? 'subscriber/1' : '',
                                        mod: role === 'moderator' ? '1' : '0',
                                        subscriber: role === 'subscriber' ? '1' : '0',
                                        vip: role === 'vip' ? '1' : '0'
                                    },
                                    badges: role === 'broadcaster' ? [{ type: 'broadcaster' }] :
                                           role === 'moderator' ? [{ type: 'moderator' }] :
                                           role === 'vip' ? [{ type: 'vip' }] :
                                           role === 'subscriber' ? [{ type: 'subscriber' }] : []
                                },
                                renderedText: command
                            }
                        }
                    };

                    // Dispatch the event
                    const event = new CustomEvent('onEventReceived', mockData);
                    window.dispatchEvent(event);
                }

                // Add role permission testing to keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey) {
                        switch(e.key) {
                            case '4':
                                e.preventDefault();
                                testRolePermissions();
                                break;
                        }
                    }
                });

                console.log('Test controls loaded. Use Ctrl+1 (start), Ctrl+2 (pause), Ctrl+3 (reset), Ctrl+4 (test permissions)');
            }, 500);
        });
    </script>
    <script src="./widget.js"></script>
</body>
</html>
